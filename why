#!/usr/bin/env lua

local arg = arg
local fs = require('fs')
local hash = require('hash')
local ipairs = ipairs
local mimetype = require('mimetype')
local pcall = pcall
local pairs = pairs
local os = os
local scgi = require('scgi')
local server = require('server')
local string = string
local table = table
local tonumber = tonumber
local io = io

local function slurp(path)
  local file = io.open(path, 'rb')
  return file:read('*all')
end

local function endswith(str, needle)
  local suffix = str:sub(-(#needle))
  return suffix == needle
end

local function merge(t1, t2, iter)
  local iter = iter or pairs
  for k, v in iter(t2) do
    t1[k] = v
  end
end

local function process_request(client, files)
  local request = client:recv()
  local status, headers = pcall(scgi.parse, request)

  if not status then
    error({code = 400, msg = headers})
  end

  local index = endswith(headers.REQUEST_URI, '/') and 'index.html' or ''
  local path = table.concat({headers.DOCUMENT_ROOT, headers.REQUEST_URI, index})

  if not files[path] then
    error({code = 404, msg = 'Unknown file'})
  end

  local file = files[path]
  local content = file.content
  local etag = file.etag

  local res_headers = {
    ['Content-Type'] = file.mime,
    ['Content-Length'] = file.length,
    ['ETag'] = etag
  }

  local none_match = headers.HTTP_IF_NONE_MATCH or ''
  if none_match == etag then
    return {code = 304, headers = {['ETag'] = etag}}
  end

  local accept_encoding = headers.HTTP_ACCEPT_ENCODING or {}
  for _, encoding in ipairs({'br', 'gzip'}) do
    if accept_encoding[encoding] and file[encoding] ~= nil then
      res_headers['Content-Encoding'] = encoding
      res_headers['Content-Length'] = file[encoding].length
      content = file[encoding].content
      break
    end
  end

  return {
    content = content,
    headers = res_headers
  }
end

local function get_compressed_file(path)
  if not fs.exist(path) then
    return nil
  end

  local content = slurp(path)
  return {
    content = content,
    length = #content
  }
end

local function add_file(path)
  local content = slurp(path)

  return {
    mime = mimetype.detect(fs.extname(path)),
    length = #content,
    content = content,
    etag = string.format("%x", hash.murmur(content)),
    gzip = get_compressed_file(path .. '.gz'),
    br = get_compressed_file(path .. '.br')
  }
end

local function get_files(dir)
  local files = {}

  if not endswith(dir, '/') then
    dir = dir .. '/'
  end

  for _, path in ipairs(fs.scandir(dir)) do
    if not endswith(path, '.gz') and not endswith(path, '.br') then
      if fs.is_dir(path) then
        merge(files, get_files(path))
      else
        files[path] = add_file(path)
      end
    end
  end

  return files
end

local function main()
  if #arg == 0 or #arg > 2 then
    print('Incorrect number of arguments')
    os.exit(1)
  end

  local document_root = arg[1]
  local port = tonumber(arg[2]) or 8000
  local files = get_files(document_root)
  local socket = server.bind(port)

  socket:accept(function(client)
    local status, resp = pcall(process_request, client, files)
    client:send(scgi.build_header(resp.code or 200, resp.headers))
    client:send(resp.content or resp.msg or '')
  end)
end

main()

